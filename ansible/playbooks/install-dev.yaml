---
- name: Dev Setup
  hosts: all
  become: false
  vars:
    kitty_macos_installation_dir: /Applications/kitty.app/
    kitty_linux_installation_dir: ~/.local/kitty.app/
  tasks:
    - name: Clone dotfiles if not done
      ansible.builtin.git:
        repo: 'https://github.com/csd1100/dotfiles'
        dest: "~/dotfiles"
        version: main
      tags:
        - dotfiles

    - name: Install kitty
      tags:
        - kitty
      block:
        - name: Install ImageMagick dependency
          become: true
          block:
            - name: Install imagemagick on Debian and Darwin
              ansible.builtin.package:
                name: imagemagick
                state: present
              when: ansible_os_family == 'Debian' or ansible_os_family == 'Darwin'

            - name: Install ImageMagick on Fedora
              ansible.builtin.dnf:
                name: ImageMagick
                state: present
              when: ansible_os_family == 'RedHat'

        - name: Set kitty installation directory for linux
          ansible.builtin.set_fact:
            kitty_installation_dir: "{{ kitty_linux_installation_dir }}"
          when: (ansible_os_family == "RedHat") or (ansible_os_family == "Debian")

        - name: Set kitty installation directory for macos
          ansible.builtin.set_fact:
            kitty_installation_dir: "{{ kitty_macos_installation_dir }}"
          when: (ansible_os_family == "Darwin")

        - name: Install kitty
          ansible.builtin.shell: |
            set -o pipefail
            curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin
          args:
            creates: "{{ kitty_installation_dir }}"
            executable: /bin/bash

        - name: Create kitty desktop file
          ansible.builtin.shell: cd ~/dotfiles/kitty/.config/kitty && ./kitty-desktop
          args:
            creates: ~/.local/share/applications/kitty.desktop
          when: (ansible_os_family == "RedHat") or (ansible_os_family == "Debian")

    - name: Install jdk
      tags:
        - dev
        - jdk
      block:
        - name: Debian install jdk 11, 17
          become: true
          ansible.builtin.apt:
            name:
              - openjdk-11-jdk
              - openjdk-17-jdk
          when: ansible_os_family == 'Debian'

        - name: RedHat install jdk 11, 17
          become: true
          ansible.builtin.dnf:
            name:
              - java-11-openjdk
              - java-17-openjdk
          when: ansible_os_family == 'RedHat'

        - name: Darwin install jdk 11, 17
          ansible.builtin.homebrew:
            name:
              - openjdk@11
              - openjdk@17
          when: ansible_os_family == 'Darwin'

    - name: Install node 18, 20
      tags:
        - dev
        - node
      block:
        - name: Install nvm
          ansible.builtin.shell: |
           PROFILE=/dev/null curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | /bin/bash
          args:
            creates: ~/.nvm/
            executable: /bin/bash

        - name: Load nvm and install node 18, 20
          ansible.builtin.shell:
            export NVM_DIR="$HOME/.nvm" &&
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" &&
            nvm install lts/hydrogen lts/iron &&
            nvm alias default lts/iron
          args:
            executable: /bin/bash

        - name: Validate node is installed
          ansible.builtin.shell:
            export NVM_DIR="$HOME/.nvm" &&
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" &&
            nvm use lts/iron &&
            nvm use lts/hydrogen &&
            nvm use default &&
            node --version | grep "v20"
          args:
            executable: /bin/bash

    - name: Install golang
      tags:
        - dev
        - golang
      block:
        - name: Install golang linux
          block:
            - name: Fetch latest go version
              ansible.builtin.uri:
                url: https://go.dev/VERSION?m=text
                return_content: true
              register: go_version_op

            - name: Store go version
              ansible.builtin.set_fact:
               go_version: "{{ go_version_op.content | regex_search('^.*') }}"

            - name: Download go
              ansible.builtin.get_url:
               url: https://go.dev/dl/{{go_version}}.linux-amd64.tar.gz
               dest: /tmp/{{go_version}}.linux-amd64.tar.gz

            - name: Remove previous go
              become: true
              ansible.builtin.file:
                state: absent
                path: /usr/local/go/

            - name: Linux install go
              become: true
              ansible.builtin.unarchive:
                src: /tmp/{{go_version}}.linux-amd64.tar.gz
                dest: /usr/local/
                remote_src: true

            - name: Validate go is installed
              ansible.builtin.shell:
                /usr/local/go/bin/go version | grep "{{ go_version }}"
          when: ansible_os_family == 'Debian' or ansible_os_family == 'RedHat'

        - name: Install golang mac
          ansible.builtin.homebrew:
            name: golang
          when: ansible_os_family == 'Darwin'

    - name: Install rust
      tags:
        - dev
        - rust
      block:
        - name: Install rust using rustup
          ansible.builtin.shell:
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          args:
            creates: ~/.rustup/

        - name: Validate rust is installed
          ansible.builtin.shell:
            ~/.cargo/bin/rustc --version

    - name: Install docker linux
      tags:
        - dev
        - docker
      block:
        - name: Ubuntu Docker Setup
          become: true
          block:
            - name: Add apt docker gpg key
              ansible.builtin.apt_key:
                url: https://download.docker.com/linux/ubuntu/gpg
                state: present
            - name: Add apt docker repository
              ansible.builtin.apt_repository:
                repo: deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
                state: present
          when: ansible_distribution == 'Ubuntu'

        - name: Fedora docker setup
          become: true
          ansible.builtin.get_url:
            url: https://download.docker.com/linux/fedora/docker-ce.repo
            dest: /etc/yum.repos.d/docer-ce.repo
          when: ansible_distribution == 'Fedora'

        - name: Install docker
          become: true
          ansible.builtin.package:
            name:
            - docker-ce
            - docker-ce-cli
            - containerd.io
            - docker-buildx-plugin
            - docker-compose-plugin
            state: latest

        - name: Add docker usergroup
          become: true
          ansible.builtin.group:
            name: docker
            state: present
            gid: 1750

        - name: Add user to docker group
          become: true
          ansible.builtin.user:
            name: "{{ ansible_user_id }}"
            append: yes
            groups: docker

        - name: Enable docker service
          become: true
          ansible.builtin.systemd:
            name: docker
            state: started
            enabled: true
      when: ansible_system == "Linux"

    - name: Install neovim nightly
      tags:
        - dev
        - nvim
      block:
      - name: nvim dependencies
        become: true
        ansible.builtin.package:
          name:
            - luajit
            - luarocks
          state: latest
        tags: nvim-deps

      - name: Install neovim linux
        block:
          - name: Add neovim apt ppa
            become: true
            ansible.builtin.apt_repository:
              repo: ppa:neovim-ppa/unstable
            when: ansible_os_family == 'Debian'

          - name: Add neovim dnf copr
            become: true
            community.general.copr:
              name: agriffis/neovim-nightly
            when: ansible_os_family == 'RedHat'

          - name: Install neovim Linux
            become: true
            ansible.builtin.package:
              name:
                - neovim
                - python3-neovim
              state: latest
        when: ansible_system == "Linux"

      - name: Install neovim Darwin
        ansible.builtin.homebrew:
          name: nvim
          state: head
        when: ansible_system == "Darwin"
