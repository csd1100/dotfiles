---
- name: Dev Setup
  hosts: all
  become: false
  vars:
    kitty_macos_installation_dir: /Applications/kitty.app/
    kitty_linux_installation_dir: ~/.local/kitty.app/
  tasks:
    - name: Clone dotfiles if not done
      ansible.builtin.git:
        repo: 'https://github.com/csd1100/dotfiles'
        dest: "~/dotfiles"
        version: main
      tags:
        - dotfiles

    - name: Install kitty
      tags:
        - kitty
      block:
        - name: Set kitty installation directory for linux
          ansible.builtin.set_fact:
            kitty_installation_dir: "{{ kitty_linux_installation_dir }}"
          when: (ansible_os_family == "RedHat") or (ansible_os_family == "Debian")

        - name: Set kitty installation directory for macos
          ansible.builtin.set_fact:
            kitty_installation_dir: "{{ kitty_macos_installation_dir }}"
          when: (ansible_os_family == "Darwin")

        - name: Install kitty
          ansible.builtin.shell: |
            set -o pipefail
            curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin
          args:
            creates: "{{ kitty_installation_dir }}"

        - name: Create kitty desktop file
          ansible.builtin.shell: cd ~/dotfiles/kitty/.config/kitty && ./kitty-desktop
          args:
            creates: ~/.local/share/applications/kitty.desktop
          when: (ansible_os_family == "RedHat") or (ansible_os_family == "Debian")

    - name: Install jdk
      tags:
        - dev
        - jdk
      block:
        - name: Debian install jdk 11, 17
          become: true
          ansible.builtin.apt:
            name:
              - openjdk-11-jdk
              - openjdk-17-jdk
          when: ansible_os_family == 'Debian'

        - name: RedHat install jdk 11, 17
          become: true
          ansible.builtin.dnf:
            name:
              - java-11-openjdk
              - java-17-openjdk
          when: ansible_os_family == 'RedHat'

        - name: Darwin install jdk 11, 17
          ansible.builtin.homebrew:
            name:
              - openjdk@11
              - openjdk@17
          when: ansible_os_family == 'Darwin'

    - name: Install node 18, 20
      tags:
        - dev
        - node
      block:
        - name: Install nvm
          ansible.builtin.shell: |
           if test -v BASH; then set -o pipefail; fi
           PROFILE=/dev/null curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | /bin/sh
          args:
            creates: ~/.nvm/

        - name: Load nvm and install node 18, 20
          ansible.builtin.shell:
            export NVM_DIR="$HOME/.nvm" &&
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" &&
            nvm install lts/hydrogen;
            nvm install lts/iron;
            nvm alias default lts/iron

    - name: Install golang
      tags:
        - dev
        - golang
      block:
        - name: Install golang linux
          block:
            - name: Fetch latest go version
              ansible.builtin.uri:
                url: https://go.dev/VERSION?m=text
                return_content: true
              register: go_version_op

            - name: Store go version
              ansible.builtin.set_fact:
               go_version: "{{ go_version_op.content | regex_search('^.*') }}"

            - name: Download go
              ansible.builtin.get_url:
               url: https://go.dev/dl/{{go_version}}.linux-amd64.tar.gz
               dest: /tmp/{{go_version}}.linux-amd64.tar.gz

            - name: Remove previous go
              become: true
              ansible.builtin.file:
                state: absent
                path: /usr/local/go/

            - ansible.builtin.file:
                path: /tmp/go-test/
                state: directory

            - name: Linux install go
              become: true
              ansible.builtin.unarchive:
                src: /tmp/{{go_version}}.linux-amd64.tar.gz
                dest: /usr/local/
                remote_src: true

            - name: Validate go is installed
              ansible.builtin.shell:
                /usr/local/go/bin/go version | grep "{{ go_version }}"
          when: ansible_os_family == 'Debian' or ansible_os_family == 'RedHat'

        - name: Install golang mac
          ansible.builtin.homebrew:
            name: golang
          when: ansible_os_family == 'Darwin'

    - name: Install rust
      tags:
        - dev
        - rust
      ansible.builtin.shell: |
        set -o pipefail
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
